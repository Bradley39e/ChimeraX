# === UCSF ChimeraX Copyright ===
# Copyright 2016 Regents of the University of California.
# All rights reserved.  This software provided pursuant to a
# license agreement containing restrictions on its disclosure,
# duplication and use.  For details see:
# http://www.rbvi.ucsf.edu/chimerax/docs/licensing.html
# This notice must be embedded in or attached to all copies,
# including partial copies, of the software or any revisions
# or derivations thereof.
# === UCSF ChimeraX Copyright ===

TOP = ../../..
include $(TOP)/mk/config.make

SUBDIRS	+= atomstruct_cpp dssp_cpp element_cpp mmcif_cpp pdb_cpp pdbio pyinstance_cpp readcif_cpp

include $(TOP)/mk/subdir.make

PKG_DIR = $(PYSITEDIR)/chimerax/core/atomic
APP_PKG_DIR = $(APP_PYSITEDIR)/chimerax/core/atomic

PYSRCS = __init__.py attr_registration.py bond_geom.py changes.py colors.py \
	idatm.py mmcif.py mmcif_write.py molc.py molarray.py molobject.py molsurf.py \
	path.py pbgroup.py pdb.py pdbmatrices.py readpbonds.py ribbon.py \
	search.py shapedrawing.py struct_edit.py sse.py structure.py triggers.py
LIBNAME = molc

SRCS	= molc.cpp
OBJS	= $(SRCS:.cpp=.$(OBJ_EXT))
HDRS 	= 
INCS	+= $(PYTHON_INCLUDE_DIRS) $(NUMPY_INC)
ifeq ($(WIN32),msvc)
LIBS	+= libatomstruct.lib libelement.lib libpyinstance.lib libarrays.lib liblogger.lib libappdirs.lib $(PYTHON_LIB)
else
LIBS	+= -latomstruct -lelement -lpyinstance -larrays -llogger -lappdirs $(PYTHON_LIB)
endif

all: $(PYOBJS) $(SHLIB)

cymol.$(PYMOD_EXT): cymol.pyx
	LDFLAGS="-L." $(PYTHON_EXE) setup.py build_ext -i
	mv cymol.cpython-36m-darwin.$(PYMOD_EXT) cymol.$(PYMOD_EXT)
	$(RSYNC) cymol.$(PYMOD_EXT) $(PKG_DIR)

install: all dir $(PYSRCS)
	$(RSYNC) $(PYSRCS) $(SHLIB) $(PKG_DIR)
ifdef WIN32
	#$(RSYNC) $(LIBRARY) $(libdir)
ifdef DEBUG
	$(RSYNC) lib$(LIBNAME).pdb $(PKG_DIR)
endif
endif

$(SHLIB): $(OBJS)
	$(SHLIB_LINK)

dir:
	if [ ! -d "$(PKG_DIR)" ]; then mkdir $(PKG_DIR); fi

clean:
	rm -rf __pycache__ $(OBJS) $(SHLIB)
ifdef WIN32
	rm -f lib$(LIBNAME).{exp,pdb} vc*.pdb
endif

pylint:
	$(PYLINT) $(PYSRCS)

molc.$(OBJ_EXT): $(includedir)/atomstruct/Atom.h $(includedir)/atomstruct/AtomicStructure.h \
	$(includedir)/atomstruct/Bond.h $(includedir)/atomstruct/Chain.h \
	$(includedir)/atomstruct/ChangeTracker.h $(includedir)/atomstruct/destruct.h \
	$(includedir)/atomstruct/PBGroup.h $(includedir)/atomstruct/PBManager.h \
	$(includedir)/atomstruct/Pseudobond.h $(includedir)/atomstruct/Residue.h \
	$(includedir)/atomstruct/RibbonXSection.h $(includedir)/atomstruct/Sequence.h \
	$(includedir)/element/Element.h $(includedir)/pyinstance/PythonInstance.declare.h \
	$(includedir)/pyinstance/PythonInstance.instantiate.h

$(includedir)/atomstruct/Atom.h: atomstruct_cpp.install
$(includedir)/atomstruct/AtomicStructure.h: atomstruct_cpp.install
$(includedir)/atomstruct/Bond.h: atomstruct_cpp.install
$(includedir)/atomstruct/Chain.h: atomstruct_cpp.install
$(includedir)/atomstruct/ChangeTracker.h: atomstruct_cpp.install
$(includedir)/atomstruct/destruct.h: atomstruct_cpp.install
$(includedir)/atomstruct/PBGroup.h: atomstruct_cpp.install
$(includedir)/atomstruct/Pseudobond.h: atomstruct_cpp.install
$(includedir)/atomstruct/Residue.h: atomstruct_cpp.install
$(includedir)/atomstruct/RibbonXSection.h: atomstruct_cpp.install
$(includedir)/atomstruct/Sequence.h: atomstruct_cpp.install
$(includedir)/element/Element.h: element_cpp.install
$(includedir)/pyinstance/PythonInstance.declare.h: pyinstance_cpp.install
$(includedir)/pyinstance/PythonInstance.instantiate.h: pyinstance_cpp.install

molobject.py: cymol.$(PYMOD_EXT)

atomstruct_cpp.install: element_cpp.install pyinstance_cpp.install
dssp_cpp.install: atomstruct_cpp.install
element_cpp.install: pyinstance_cpp.install
mmcif_cpp.install: readcif_cpp.install atomstruct_cpp.install
pdbio.install: atomstruct_cpp.install pdb_cpp.install
