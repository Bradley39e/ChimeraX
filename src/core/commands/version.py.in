# vim: set expandtab shiftwidth=4 softtabstop=4:


def version(session, format='terse'):
    '''Show version information.

    Parameters
    ----------
    format : one of 'terse', ''bundles', or 'package'
        
    '''
    import pip
    dists = pip.get_installed_distributions(local_only=True)
    if not dists:
        sess.logger.error("no version information available")
        return os.EX_SOFTWARE
    for d in dists:
        if d.key == 'chimerax.core':
            version = d.version
            break
    if version is None:
        version = 'unknown'
    session.logger.info("%s version: %s" % (session.app_dirs.appname, version))
    session.logger.info("date: DAYTIME")
    session.logger.info("branch: BRANCH")
    session.logger.info("commit: COMMIT")
    if format == 'terse':
        return
    dists = list(dists)
    dists.sort(key=lambda d: d.key)
    if format == 'bundles':
        session.logger.info("Installed bundles:")
    else:
        session.logger.info("Installed packages:")
    for d in dists:
        key = d.key
        if format == 'bundles':
            if not key.startswith('chimerax.'):
                continue
            key = key[len('chimerax.'):]
        if d.has_version():
            session.logger.info("    %s: %s" % (key, d.version))
        else:
            session.logger.info("    %s: unknown" % key)


def register_command(session):
    from . import cli
    desc = cli.CmdDesc(
        optional=[('format', cli.EnumOf(['terse', 'bundles', 'package']))],
        non_keyword=['format'],
        synopsis='show version information')
    cli.register('version', desc, version)
