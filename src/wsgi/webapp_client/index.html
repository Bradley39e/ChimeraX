<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "https://www.w3.org/TR/html4/strict.dtd">
<html>
<!-- vi: se sw=2: -->
<head>
<meta charset="utf-8"/>
<title>Chimera 2 Web Application</title>
<!-- standard jquery/jquery-ui -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.js"></script>
<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
<script type="text/javascript" src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
<script src="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>

<!-- additional widgets -->
<script type="text/javascript" src="js/jquery.jec-1.3.4.js"></script>

<!-- chimera2 libraries -->
<script type="text/javascript" src="js/c2/session.js"></script>

<!-- WebGL support -->
<!-- <script type="text/javascript" src="webgl/webgl-debug.js"></script> -->
<script type="text/javascript" src="webgl/webgl-utils.js"></script>
<script type="text/javascript" src="webgl/webgl-context.js"></script>
<script type="text/javascript" src="webgl/llgr_webgl.js"></script>
<script type="text/javascript" src="js/gl-matrix.js"></script>
<script type="text/javascript" src="js/vsphere.js"></script>

<!-- page-specific script and css -->
<style type="text/css">
.footer-button { width:100px; }
.footer-left { text-align:left; padding:0px 10px; }
.footer-right { text-align:right; padding:0px 10px; }
#molview {
	position: relative;
	margin: 0px;
}
</style>

<script type="text/javascript">

function array_search(arr, func) {
	if (!func || typeof(func) != 'function')
		return -1;
	if (!arr || !arr.length || arr.length < 1)
		return -1;
	var len = arr.length;
	for (var i = 0; i < len; ++i) {
		if (func(arr[i]))
			return i;
	}
	return -1;
}

function array_reverse_search(arr, func) {
	if (!func || typeof(func) != 'function')
		return -1;
	if (!arr || !arr.length || arr.length < 1)
		return -1;
	for (var i = arr.length - 1; i >= 0; --i) {
		if (func(arr[i]))
			return i;
	}
	return -1;
}

function array_index_of(arr, field, value) {
	var i = array_search(arr, function(obj) {
		if (obj[field] != undefined)
			return obj[field] == value;
		else
			return false;
	});
	return i;
} 

function array_last_index_of(arr, field, value) {
	var i = array_reverse_search(arr, function(obj) {
		if (obj[field] != undefined)
			return obj[field] == value;
		else
			return false;
	});
	return i;
} 

// show_error is global
function show_error(message) {
	show_status(message, { error: true, delay: 10000 });
	return;
	// TODO: dialog not working with jQuery mobile, use popup
	var dialog_id = "error_dialog_" + new Date().getTime();
	$("body").append("<div id=\"" + dialog_id + "\"><p>"
		+ "<span class=\"ui-icon ui-icon-alert\" style=\"float: left; margin: 0 7px 20px 0;\"></span>"
		+ "<div>" + message + "</div></p></div>");
	$("#" + dialog_id).dialog({
		dialogClass: "error",
		title: "Chimera2 Error",
		resizable: false,
		height: 160,
		modal: true,
		buttons: {
			"Close": function () {
				$(this).dialog("close");
			}
		},
		beforeClose: function (event, ui) {
			// remove dialog div from document
			$("#" + dialog_id).remove();
		}
	});
}

// show_status is global
function show_status(message, options) {
	options = options || {};
	var delay = options.delay || 3000;	// milliseconds
	var error = options.error || false;
	var temporary = options.temporary || false;
	var sl = $("#status_line");
	sl.clearQueue().html(message);
	if (error)
		sl.addClass("ui-state-error-text");
	sl.delay(delay).queue(function () {
		$(this).html("&nbsp;").removeClass("ui-state-error-text").dequeue();
	});
	if (!temporary) {
		if (!error)
			$c2_session.log(message);
		else {
			$c2_session.log("<div class=\"ui-state-error-text\">" + message + "</div>");
		}
	}
}

(function () {
"use strict";

function BBox(llb, urf) {
    // right-handed axis-aligned bounding box
    // 
    // if either llb or urf are undefined,
    // then the bounding box is uninitialized.
    this.llb = llb;	// lower-left-back corner coordinates
    this.urf = urf;	// upper-right-front corner coordinates
}

BBox.prototype.add = function (pt) {
    // expand bounding box to encompass given point
    if (this.llb === undefined) {
	this.llb = vec3.copy(vec.create(), pt);
	this.urf = vec3.copy(vec.create(), pt);
	return;
    }
    for (var i = 0; i < 3; ++i) {
	if (pt[i] < this.llb[i])
	    this.llb[i] = pt[i];
	else if (pt[i] > this.urf[i])
	    this.urf[i] = pt[i];
    }
}

BBox.prototype.add_bbox = function (box) {
    // expand bounding box to encompass given bounding box
    if (this.llb === undefined) {
	this.llb = box.llb;
	this.urf = box.urf;
	return;
    }
    for (var i = 0; i < 3; ++i) {
	if (box.llb[i] < this.llb[i])
	    this.llb[i] = box.llb[i];
	if (box.urf[i] > this.urf[i])
	    this.urf[i] = box.urf[i];
    }
}

BBox.prototype.bulk_add = function (pts) {
    throw "bulk_add not implemented";
    // expand bounding box to encompass all given points
    mi = amin(pts, axis=0)	// TODO
    ma = amax(pts, axis=0)	// TODO
    if (this.llb === undefined) {
	this.llb = vec3.copy(vec3.create(), mi);
	this.urf = vec3.copy(vec3.create(), ma);
	return;
    }
    for (var i = 0; i < 3; ++i) {
	if (mi[i] < this.llb[i])
	    this.llb[i] = mi[i];
	if (ma[i] > this.urf[i])
	    this.urf[i] = ma[i];
    }
}

BBox.prototype.center = function () {
    // return center of bounding box
    if (this.llb === undefined)
	throw "empty bounding box";
    var c = vec3.add(vec3.create(), this.llb, this.urf);
    vec3.scale(c, c, .5);
    return c;
}

BBox.prototype.size = function () {
    // return length of sides of bounding box
    if (this.llb === undefined)
	throw "empty bounding box";
    return vec3.subtract(vec3.create(), this.urf, this.llb);
}

BBox.prototype.xform = function (xf) {
    // transform bounding box in place
//  if xf.isIdentity:
//	return;
    b = BBox([0., 0., 0.], [0., 0., 0.]);
    for (var i = 0; i < 3; ++i) {
	b.llb[i] = b.urf[i] = xf._matrix[i][3];
	for (var j = 0; j < 3; ++j) {
	    coeff = xf._matrix[i][j];
	    if (coeff == 0)
		continue;
	    if (coeff > 0) {
		b.llb[i] += this.llb[j] * coeff;
		b.urf[i] += this.urf[j] * coeff;
	    } else {
		b.llb[i] += this.urf[j] * coeff;
		b.urf[i] += this.llb[j] * coeff;
	    }
	}
    }
    this.llb = b.llb;
    this.urf = b.urf;
}

function Camera() {
	this.eye = vec3.fromValues(0, 0, 0);
	this.at = vec3.fromValues(0, 0, -1);
	this.up = vec3.fromValues(0, 1, 0);
	this.ortho = false;
}

Camera.prototype.reset = function (width, height, fov, bbox) {
	// The camera is a simple one that takes the :param fov: and
	// the current bounding box, and calculates the eye position
	// and looks at the bounding box down the negative z-axis.
	this.at = bbox.center();
	var half_size = bbox.size();
	vec3.scale(half_size, half_size, .5 * 1.1);	// + 10%
	this.width2 = half_size[0];
	this.height2 = half_size[1];
	var depth2 = half_size[2];
	this.update_viewport(width, height);

	this.near = this.height2 / Math.tan(fov / 2);
	this.far = this.near + 2 * depth2;
	this.eye = vec3.fromValues(this.at[0], this.at[1], this.at[2] + this.near + depth2);
	this.up = vec3.fromValues(0, 1, 0);	// Direction
}

Camera.prototype.update_viewport = function (width, height) {
	var win_aspect = width / height;
	var scene_aspect = this.width2 / this.height2;
	if (win_aspect > scene_aspect)
		this.width2 = this.height2 * win_aspect;
	else
		this.height2 = this.width2 / win_aspect;
}

Camera.prototype.matrices = function () {
	var projection;
	if (this.ortho) {
		projection = mat4.ortho(mat4.create(),
			-this.width2, this.width2,
			-this.height2, this.height2,
			this.near, this.far);
	} else {
		projection = mat4.frustum(mat4.create(),
			-this.width2, this.width2,
			-this.height2, this.height2,
			this.near, this.far);
	}
	var modelview = mat4.lookAt(mat4.create(), this.eye, this.at, this.up);
	return [projection, modelview];
}

Camera.prototype.rotate = function (axis, angle) {
	var xf = Rotation(axis, angle);
	this.xform(xf);
}

Camera.prototype.xform = function (xf) {
	//if not xf._pure:
	//	throw 'only pure rotation is allowed);
	var inv_trans = vec3.negate(vec3.create(), this.at);
	var inv_xf = mat4.invert(mat4.create(), xf);
	var nxf = mat4.create();
	mat4.translate(nxf, nxf, this.at);
	mat4.multiply(nxf, nxf, inv_xf);
	mat4.translate(nxf, nxf, inv_trans);
	vec3.transformMat4(this.eye, this.eye, nxf);
	var rot = mat3.fromMat4(mat3.create(), nxf);
	vec3.transformMat3(this.up, this.up, rot);
	vec3.transformMat4(this.at, this.at, nxf);
}

$(document).ready(function() {
	$c2_session.ui_init("..");
	$("#command_line").keyup(
		function (evt) {
			if (evt.which != 13)
				return;
			$c2_session.send_command($(this).val());
		});
	$c2_session.register_data_function("llgr", process_llgr_data);
	$c2_session.register_data_function("scene", process_scene_data);
	$c2_session.register_data_function("info", show_status);
	molview_init();
})

function process_llgr_data(json) {
	// json is list of llgr commands
	var index = array_last_index_of(json, 0, "clear_all");
	if (index == -1) {
		// partial update, so merge with existing data
		llgr.load_json(json);
		molview_ci.data = molview_ci.data.concat(json);
		molview_ci.redraw();
	} else {
		json.splice(0, index + 1);
		molview_ci.data = json;
		molview_ci.init();
	}
}

var camera = null;
var scene_bbox;
var scene_fov;

function process_scene_data(data) {
	var bbox = data["bbox"];
	if (bbox === undefined) {
		return;
	}
	bbox = new BBox(vec3.fromValues.apply(null, bbox[0]),
	    				vec3.fromValues.apply(null, bbox[1]));
	if (bbox != scene_bbox) {
		scene_bbox = bbox;
		// TODO: update camera
		camera = null;
	}
	var fov = data["fov"];
	if (fov === undefined)
		return;
	if (fov != scene_fov) {
		scene_fov = fov;
		// TODO: update camera
	}
	var eye = vec3.fromValues.apply(null, data["eye"]);
	var at = vec3.fromValues.apply(null, data["at"]);
	var up = vec3.fromValues.apply(null, data["up"]);
	// TODO: setup camera
}

var molview_ci;		// molview context information

var button_pressed = false;
var mouse_position;

function molview_zoom(event) {
	console.log("zoom:", event);
	event.stopPropagation();
}

function get_rel_xy(event) {
	var widget = event.currentTarget;
	var widget_offset = $(widget).offset();
	return {
		x: event.pageX - widget_offset.left,
		y: event.pageY - widget_offset.top
	};
}

function molview_mouse_down(event) {
	// TODO: change cursor
	console.log("mouse_down:", event);
	event.stopPropagation();
	button_pressed = true;
	var canvas = event.currentTarget;
	var radius = 0.9 * 0.5 * Math.min(canvas.width, canvas.height);
	mouse_position = get_rel_xy(event);
	mouse_position.x = (mouse_position.x - (canvas.width / 2)) / radius;
	mouse_position.y = ((canvas.height / 2) - mouse_position.y) / radius;
}

function molview_mouse_move(event) {
	// TODO: change cursor
	if (!button_pressed || camera === null)
		return;
	event.stopPropagation();
	var canvas = event.currentTarget;
	var radius = 0.9 * 0.5 * Math.min(canvas.width, canvas.height);
	var new_position = get_rel_xy(event);
	new_position.x = (new_position.x - (canvas.width / 2)) / radius;
	new_position.y = ((canvas.height / 2) - new_position.y) / radius;
	var rot_mat;
	try {
		rot_mat = vsphere(mouse_position, new_position);
	} catch (err) {
		// skip
	}
	mouse_position = new_position;
	if (rot_mat === undefined)
		return;
	camera.xform(rot_mat);
	molview_ci.redraw();
}

function molview_mouse_up(event) {
	// TODO: change cursor
	//console.log("mouse_up:", event);
	event.stopPropagation();
	button_pressed = false;
}

function molview_init() {
	var canvas = document.getElementById("molview");
	var gl = getWebGLContext(canvas, {
		alpha: false,
		antialias: true
	});
	if (!gl)
		return;

	molview_ci = new ContextInfo(canvas, gl, draw_scene);
	molview_ci.init();
	molview_ci.redraw();
	$("#molview")
		.on('wheel', molview_zoom)
		.mousedown(molview_mouse_down)
		.mousemove(molview_mouse_move)
		.mouseup(molview_mouse_up);
}

function draw_scene(ci) {
	//console.log("draw_scene");
	var canvas = ci.canvas;
	var gl = ci.gl;
	var width = canvas.width;
	var height = canvas.height;
	$c2_session.set_state("width", width);
	$c2_session.set_state("height", height);
	llgr.set_context(gl);
	gl.viewport(0, 0, width, height);
	if (camera !== null) {
		camera.update_viewport(width, height);
	} else {
		if (scene_bbox === undefined) {
			gl.clear(gl.COLOR_BUFFER_BIT);
			return;
		}
		camera = new Camera();
		camera.reset(width, height, scene_fov, scene_bbox);
	}
	var result = camera.matrices();
	var projection = result[0];
	var modelview = result[1];
	llgr.set_uniform_matrix(0, 'ProjectionMatrix', false,
		llgr.Mat4x4, projection);
	llgr.set_uniform_matrix(0, 'ModelViewMatrix', false,
		llgr.Mat4x4, modelview);
	llgr.set_uniform_matrix(0, 'NormalMatrix', false,
		llgr.Mat3x3, mat3.fromMat4(mat3.create(), modelview));
	llgr.render();
}

$(function() {
	$("#molview").resizable({
		handles: "",
		resize: function (event, ui) {
			$("canvas", this).each(function () {
				$(this).attr({
					width: ui.size.width,
					height: ui.size.height
				});
				molview_ci.redraw();
			});
		},
	});
});

}());

</script>
</head>
<body>
<h1>Session Javascript Test Page</h1>
<div data-role="page" class="ui-responsive-panel">

<!--panels-->
<div data-role="panel" data-position-fixed="true"
	data-display="push" id="log_panel">
  <h2>Message Log</h2>
  <p id="log" style="font-size: smaller"></p>
  <a data-role="button" data-rel="close" data-icon="delete" href="#">Close</a>
</div>
<div data-role="panel" data-position-fixed="true"
	data-display="push" data-position="right" id="debug_panel">
  <h2>Debug Log</h2>
  <p id="debug" style="font-size: smaller">Debug text</p>
  <a data-role="button" data-rel="close" data-icon="delete" href="#">Close</a>
</div>
<!--end panels-->

<!--popups-->
<div data-role="popup" name="session_popup" id="session_popup">
  <div data-role="collapsible-set" data-mini="true">
    <div data-role="collapsible" data-collapsed="false">
      <h3>My Sessions</h3>
      <form>
	<label for="my_sessions">Session:</label>
	<select name="my_sessions" id="my_sessions" data-mini="true">
	  <option value="xyzzy">xyzzy</option>
	  <option value="plugh">plugh</option>
	</select>
	<label for="my_password">Password:</label>
	<input type="password" name="my_password" id="my_password"
	      value="" data-mini="true" />
	<input type="button" value="Open" id="open_session"
	      data-inline="true" data-mini="true" data-theme="b"/>
	<input type="button" value="Delete" id="delete_session"
	      data-inline="true" data-mini="true" data-theme="b"/>
      </form>
    </div>
    <div data-role="collapsible" data-collapsed="true">
      <h3>New Sessions</h3>
      <form>
	<label for="new_session">Session:</label>
	<input type="text" name="new_session" id="new_session"
	      value="" data-mini="true" />
	<label for="new_password">Password:</label>
	<input type="password" name="new_password" id="new_password"
	      value="" data-mini="true" />
	<input type="button" value="Create" id="open_new_session"
	      data-inline="true" data-mini="true" data-theme="b"/>
      </form>
    </div>
    <div data-role="collapsible" data-collapsed="true">
      <h3>Shared Session</h3>
      <form>
	<label for="shared_username">User name:</label>
	<input type="text" name="shared_username" id="shared_username"
	      value="" data-mini="true" />
	<label for="shared_session">Session:</label>
	<input type="text" name="shared_session" id="shared_session"
	      value="" data-mini="true" />
	<label for="shared_password">Password:</label>
	<input type="password" name="shared_password" id="shared_password"
	      value="" data-mini="true"/>
	<input type="button" value="Open" id="open_shared_session"
	      data-inline="true" data-mini="true" data-theme="b"/>
      </form>
    </div>
  </div>
</div>
<!--end popups-->

<!--main content-->
<div data-role="content">
  <div>
    <label for="command_line">Command:</label>
    <input id="command_line" type="text" size="100"/>
  </div>
  <div>
    <span id="status_line">&nbsp;</span>
  </div>
  <div>
   <canvas id="molview" width="500" height="500" class="ui-widget-content">
    Your browser does not support the HTML5
    <code>&lt;canvas&gt;</code> element.
    <a href="http://get.webgl.org">Click here to upgrade your browser.</a>
   </canvas>
  </div>
  <hr/>
</div>
<!--end main content-->

<!--footer-->
<div data-role="footer">
  <div class="ui-grid-a">
    <div class="ui-block-a footer-left">
      <span id="active_session">No session selected</span>
      <div data-role="controlgroup" data-type="horizontal" data-mini="true">
	<a data-role="button" class="footer-button"
	      id="open_session_popup" data-mini="true"
	      href="#session_popup" data-rel="popup">Session</a>
	<a data-role="button" data-mini="true"
	      class="footer-button" href="#log_panel">Log</a>
	<a data-role="button" data-mini="true"
	      class="footer-button" href="#debug_panel">Debug Log</a>
      </div>
    </div>
    <div class="ui-block-b footer-right">
      <h4>Chimera 2 Mobile<br/>
      Developed at the <a href="http://www.rbvi.ucsf.edu">RBVI</a></h4>
    </div>
  </div>
</div>
<!--end footer-->

</div>
</body>
</html>
