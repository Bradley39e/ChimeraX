FOREIGN_MAKE = 1
TOP	= ../..
include $(TOP)/mk/config.make

# PYTHON_VERSION is in config.make
PYTHON_PATCH_LEVEL = $(PYTHON_VERSION).3
DISTRIBUTION = Python-$(PYTHON_PATCH_LEVEL).tar.bz2
SOURCE = $(tmpdir)/Python-$(PYTHON_PATCH_LEVEL)

QUOTE_CC := $(subst ','\'',$(CC) $(TARGET_ARCH))
QUOTE_CXX := $(subst ','\'',$(CXX) $(TARGET_ARCH))

# Make Python use our compiler options
ENV_CONFIGURE = env CC='$(QUOTE_CC) -I$(includedir) -L$(libdir) -DUSE_DYLD_GLOBAL_NAMESPACE' CXX='$(QUOTE_CXX) -I$(includedir) -L$(libdir)'

ifdef DEBUG
ENV_CONFIGURE += OPT='$(OPT)'
endif

PATCHES	= $(wildcard Python-$(PYTHON_PATCH_LEVEL)-*.patch) \
	  $(wildcard Python-$(PYTHON_PATCH_LEVEL)_$(OS).patch) \
	  $(wildcard Python-$(PYTHON_PATCH_LEVEL)_$(OS)_$(OPENGL_PLATFORM).patch)
ifdef DEBUG
PATCHES += $(wildcard Python-$(PYTHON_PATCH_LEVEL)_debug.patch)
endif

LIBREPLACE = $(wildcard Python-$(PYTHON_PATCH_LEVEL)-*.py)

ifeq ($(OS),Linux)
# On linux have to disable IPV6 socket support or _socket doesn't compile.
# Use UCS-4 to be compatible with Ubuntu and RedHat/Fedora
CONFIG_OPTIONS += --disable-ipv6 --enable-unicode=ucs4 --enable-shared
endif

ifndef USE_MAC_FRAMEWORKS
ENV_CONFIGURE += LDFLAGS='$(LDFLAGS)'
else
ENV_CONFIGURE += LDFLAGS='$(LDFLAGS) -F$(frameworkdir)'
CONFIG_OPTIONS += --enable-framework DESTDIR=$(build_prefix)
PYTHON_FW = $(frameworkdir)/Python.framework
endif

ifeq ($(OS),Windows)
ifeq ($(OSARCH),Windows64)
REGTOOL = regtool -w
CONFIG = Release
PLATFORM = x64
else
REGTOOL = regtool
CONFIG = Release
PLATFORM = Win32
endif
CONFIG_PLATFORM = '$(CONFIG)|$(PLATFORM)'

_PYDIR_MACHINE = /machine/SOFTWARE/Python/PythonCore/$(PYTHON_VERSION)/InstallPath/
_PYDIR_USER = /user/SOFTWARE/Python/PythonCore/$(PYTHON_VERSION)/InstallPath/
ifeq ($(shell $(REGTOOL) -q check $(_PYDIR_MACHINE) && echo found),found)
	PYDIR   = $(shell cygpath -u '$(shell $(REGTOOL) get $(_PYDIR_MACHINE))')
endif
ifeq ($(shell $(REGTOOL) -q check $(_PYDIR_USER) && echo found),found)
	PYDIR   = $(shell cygpath -u '$(shell $(REGTOOL) get $(_PYDIR_USER))')
endif
endif # Windows

ifdef DEBUG
CONFIG_OPTIONS += --with-pydebug
endif

ifneq (,$(shell [ ! -e $(TOP)/build_type ] || [ `cat $(TOP)/build_type` = alpha ] && echo found))
# stuff to do only if it is a private or daily build
ifneq (,$(wildcard /usr/include/valgrind/valgrind.h))
CONFIG_OPTIONS += --with-valgrind
endif
endif

# 64-bit Linux dies in exception handling if we don't link with the C++ compiler
CONFIG_OPTIONS += --with-cxx-main

all:

install: $(SOURCE)
ifeq ($(OS),Windows)
	#cd $(SOURCE)/PCbuild ; cmd /c build.bat -p $(PLATFORM) 
	#cd $(SOURCE)/PCbuild ; env HOST_PYTHON=`cygpath -m '$(SOURCE)/PCbuild/amd64/python.exe'` devenv.com pcbuild.sln /build $(CONFIG_PLATFORM) /project _ssl
	test -n '$(PYDIR)'
	$(RSYNC) --include=*.exe --exclude='site-packages/*' \
	  $(PYDIR)/DLLs \
	  $(PYDIR)/Lib \
	  $(PYDIR)/include \
	  $(PYDIR)/libs \
	  $(PYDIR)/python.exe \
	  $(PYDIR)/pythonw.exe \
	  $(bindir)
else ifndef USE_MAC_FRAMEWORKS
	cd $(SOURCE) && $(MAKE) install
else
	cd $(SOURCE) && $(MAKE)
	cd $(SOURCE) && $(MAKE) -j1 frameworkinstall DESTDIR=$(build_prefix)
	cp $(SOURCE)/python.exe $(bindir)/python$(PYTHON_VERSION)
	cd $(bindir) && ln -fs python$(PYTHON_VERSION) python
	rm -rf '$(build_prefix)/Applications/Python $(PYTHON_VERSION)'
	rm -rf $(build_prefix)/usr $(build_prefix)/Users
	cd $(libdir) && \
	  ln -fs ../Library/Frameworks/Python.framework/Versions/$(PYTHON_VERSION)/lib/python$(PYTHON_VERSION) . && \
	  ln -fs ../Library/Frameworks/Python.framework/Versions/$(PYTHON_VERSION)/lib/libpython$(PYTHON_VERSION).$(SHLIB_EXT) .
	cd $(includedir) && \
	  ln -fs ../Library/Frameworks/Python.framework/Versions/$(PYTHON_VERSION)/include/python$(PYTHON_VERSION) .
endif
	# double check that pyexpat was successfully made
	test -f $(pymoddir)/pyexpat.*

$(SOURCE):
ifneq ($(OS),Windows)
	tar jxf $(DISTRIBUTION) -C $(tmpdir)

	# avoid bootstrap (files generated by python, but python isn't built)
	cd $(SOURCE) && touch Python/Python-ast.c Include/Python-ast.h

ifneq (,$(PATCHES))
	for p in $(PATCHES); do \
		(cd $(SOURCE) && patch -f -p0) < $$p ; \
	done
endif
ifneq (,$(LIBREPLACE))
	for p in $(LIBREPLACE); do \
		name=`echo $$p | sed 's/.*-//'`; \
		cp -f $$p $(SOURCE)/Lib/$$name ; \
	done
endif
	cd $(SOURCE) && $(ENV_CONFIGURE) \
	    ./configure --prefix=$(build_prefix) $(CONFIG_OPTIONS)
	# Don't use stuff from /usr/local (especially Tcl, Tk, and SSL)
	cd $(SOURCE) && \
	    mv setup.py setup.py.orig ; \
	    sed -e 's;/usr/local;$(build_prefix);' -e 's;/ssl/;/;' < setup.py.orig > setup.py
ifdef USE_MAC_FRAMEWORKS
	# say where to find Tcl and Tk (and any other frameworks)
	(echo ':/framework_dirs =/s:$$: "$(frameworkdir)",:'; echo ':wq') \
	    | env TERM=dumb ex -s $(SOURCE)/setup.py
	(echo ':/^BASECFLAGS/s:$$: -F$(frameworkdir):'; echo ':wq') \
	    | env TERM=dumb ex -s $(SOURCE)/Makefile
endif
endif

clean:
	rm -rf $(SOURCE)
